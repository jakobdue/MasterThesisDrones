from __future__ import annotations
import sys
from importlib.machinery import ModuleSpec, PathFinder
from importlib.machinery import all_suffixes as module_suffixes
from importlib.util import spec_from_file_location
from itertools import chain
from pathlib import Path

MAPPING: dict[str, str] = {'cflib': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/cflib', 'docs': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs', 'examples.aideck': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/aideck', 'examples.autonomy': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/autonomy', 'examples.cache': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/cache', 'examples.color_led_deck': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/color_led_deck', 'examples.console': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/console', 'examples.generic_led_deck': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/generic_led_deck', 'examples.led-ring': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/led-ring', 'examples.lighthouse': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/lighthouse', 'examples.link_quality': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/link_quality', 'examples.loco_nodes': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/loco_nodes', 'examples.logging': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/logging', 'examples.memory': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/memory', 'examples.mocap': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/mocap', 'examples.motors': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/motors', 'examples.multiranger': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/multiranger', 'examples.parameters': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/parameters', 'examples.positioning': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/positioning', 'examples.radio': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/radio', 'examples.step-by-step': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/step-by-step', 'examples.swarm': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/swarm', 'lpslib': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/lpslib', 'sys_test': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/sys_test', 'test.crazyflie': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/test/crazyflie', 'test.crtp': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/test/crtp', 'test.localization': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/test/localization', 'test.positioning': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/test/positioning', 'test.support': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/test/support', 'test.utils': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/test/utils', 'tools': '/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/tools'}
NAMESPACES: dict[str, list[str]] = {'tools': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/tools'], 'docs': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs'], 'examples.autonomy': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/autonomy'], 'examples.positioning': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/positioning'], 'examples.mocap': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/mocap'], 'examples.radio': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/radio'], 'examples.cache': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/cache'], 'examples.generic_led_deck': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/generic_led_deck'], 'examples.swarm': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/swarm'], 'examples.multiranger': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/multiranger'], 'examples.link_quality': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/link_quality'], 'examples.led-ring': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/led-ring'], 'examples.color_led_deck': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/color_led_deck'], 'examples.lighthouse': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/lighthouse'], 'examples.loco_nodes': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/loco_nodes'], 'examples.aideck': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/aideck'], 'examples.memory': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/memory'], 'examples.logging': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/logging'], 'examples.parameters': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/parameters'], 'examples.step-by-step': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/step-by-step'], 'examples.console': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/console'], 'examples.motors': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/motors'], 'examples.multiranger.wall_following': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/examples/multiranger/wall_following'], 'sys_test.single_cf_grounded': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/sys_test/single_cf_grounded'], 'tools.build': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/tools/build'], 'tools.build-docs': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/tools/build-docs'], 'docs.installation': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs/installation'], 'docs.development': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs/development'], 'docs.functional-areas': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs/functional-areas'], 'docs.api': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs/api'], 'docs.user-guides': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs/user-guides'], 'docs.images': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs/images'], 'docs.api.template': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs/api/template'], 'docs.api.cflib': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/docs/api/cflib'], 'test.localization.fixtures': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/test/localization/fixtures'], 'test.utils.fixtures': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/test/utils/fixtures'], 'cflib.resources': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/cflib/resources'], 'cflib.resources.binaries': ['/home/jakob/Desktop/Crazyflies/crazyflie-lib-python/cflib/resources/binaries'], 'examples': [], 'test': []}
PATH_PLACEHOLDER = '__editable__.cflib-0.1.31.post1.dev3+gcb2a9df75.finder' + ".__path_hook__"


class _EditableFinder:  # MetaPathFinder
    @classmethod
    def find_spec(cls, fullname: str, path=None, target=None) -> ModuleSpec | None:  # type: ignore
        # Top-level packages and modules (we know these exist in the FS)
        if fullname in MAPPING:
            pkg_path = MAPPING[fullname]
            return cls._find_spec(fullname, Path(pkg_path))

        # Handle immediate children modules (required for namespaces to work)
        # To avoid problems with case sensitivity in the file system we delegate
        # to the importlib.machinery implementation.
        parent, _, child = fullname.rpartition(".")
        if parent and parent in MAPPING:
            return PathFinder.find_spec(fullname, path=[MAPPING[parent]])

        # Other levels of nesting should be handled automatically by importlib
        # using the parent path.
        return None

    @classmethod
    def _find_spec(cls, fullname: str, candidate_path: Path) -> ModuleSpec | None:
        init = candidate_path / "__init__.py"
        candidates = (candidate_path.with_suffix(x) for x in module_suffixes())
        for candidate in chain([init], candidates):
            if candidate.exists():
                return spec_from_file_location(fullname, candidate)
        return None


class _EditableNamespaceFinder:  # PathEntryFinder
    @classmethod
    def _path_hook(cls, path) -> type[_EditableNamespaceFinder]:
        if path == PATH_PLACEHOLDER:
            return cls
        raise ImportError

    @classmethod
    def _paths(cls, fullname: str) -> list[str]:
        paths = NAMESPACES[fullname]
        if not paths and fullname in MAPPING:
            paths = [MAPPING[fullname]]
        # Always add placeholder, for 2 reasons:
        # 1. __path__ cannot be empty for the spec to be considered namespace.
        # 2. In the case of nested namespaces, we need to force
        #    import machinery to query _EditableNamespaceFinder again.
        return [*paths, PATH_PLACEHOLDER]

    @classmethod
    def find_spec(cls, fullname: str, target=None) -> ModuleSpec | None:  # type: ignore
        if fullname in NAMESPACES:
            spec = ModuleSpec(fullname, None, is_package=True)
            spec.submodule_search_locations = cls._paths(fullname)
            return spec
        return None

    @classmethod
    def find_module(cls, _fullname) -> None:
        return None


def install():
    if not any(finder == _EditableFinder for finder in sys.meta_path):
        sys.meta_path.append(_EditableFinder)

    if not NAMESPACES:
        return

    if not any(hook == _EditableNamespaceFinder._path_hook for hook in sys.path_hooks):
        # PathEntryFinder is needed to create NamespaceSpec without private APIS
        sys.path_hooks.append(_EditableNamespaceFinder._path_hook)
    if PATH_PLACEHOLDER not in sys.path:
        sys.path.append(PATH_PLACEHOLDER)  # Used just to trigger the path hook
